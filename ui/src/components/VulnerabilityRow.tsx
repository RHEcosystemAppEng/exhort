import {Td, Tr} from '@patternfly/react-table';
import {DependencyLink} from './DependencyLink';
import {RemediationLink} from './RemediationLink';
import {VulnerabilityLink} from './VulnerabilityLink';
import {VulnerabilityScore} from './VulnerabilityScore';
import {VulnerabilitySeverityLabel} from './VulnerabilitySeverityLabel';
import {usePrivateIssueHelper} from "../hooks/usePrivateDataHelper";
import { SYNK_SIGNUP_URL } from '../utils/utils';
import {hasRemediations, VulnerabilityItem} from "../api/report";

interface VulnerabilityRowProps {
  item: VulnerabilityItem;
  providerName: string;
  rowIndex: number;
}

export const VulnerabilityRow: React.FC<VulnerabilityRowProps> = ({ item, providerName, rowIndex }) => {
  const ids = item.vulnerability.cves ? item.vulnerability.cves : [item.vulnerability.id];
  const privateIssueHelper = usePrivateIssueHelper();
  const isHidden = privateIssueHelper.hideIssue(providerName, item.vulnerability.unique);

  return (
    <Tr key={rowIndex}>
      {isHidden ? (
        <>
          <Td colSpan={3}>
            <a href={SYNK_SIGNUP_URL} target="_blank" rel="noreferrer">
              Sign up for a Snyk account to learn about the vulnerabilities found
            </a>
          </Td>
        </>
      ) : (
        <>
          <Td>
            {ids.map((cve, cveIndex) => (
              <p key={cveIndex}>{cve}</p>
            ))}
          </Td>
          <Td>{item.vulnerability.title}</Td>
          <Td noPadding>
            <VulnerabilitySeverityLabel vulnerability={item.vulnerability} />
          </Td>
        </>
      )}
      <Td>
        <VulnerabilityScore vulnerability={item.vulnerability} />
      </Td>
      <Td>
        <DependencyLink name={item.dependencyRef} />
      </Td>
      <Td>
        {item.vulnerability.remediation?.trustedContent && (
          <RemediationLink key={rowIndex} cves={item.vulnerability.cves || []} packageName={item.dependencyRef} />
        )}
        {item.vulnerability.remediation?.fixedIn && (
          <VulnerabilityLink sourceName={providerName} vulnerability={item.vulnerability} />
        )}
        {!hasRemediations(item.vulnerability) && "N/A"}
      </Td>
    </Tr>
  );
};
